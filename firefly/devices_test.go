package firefly

import (
	"testing"
	"github.com/jarcoal/httpmock"
)

const allPacketsResponse = `{"packets":[{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:50:30","port":2,"payload_encrypted":false,"payload":"0000FA0CCE56181A80","parsed":{"col_R":86,"col_G":24,"col_C":128,"col_B":26,"VBat1000tel":3278,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.278},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":4264541596,"time":"2016-09-06T11:50:30.257178Z","rssi":-109,"rcv_time":-576198901700474,"lsnr":-2.2,"gweui":"0000024B0806019A"},{"tmst":78153012,"time":"2016-09-06T11:50:29.581553Z","rssi":-120,"rcv_time":-576198901753592,"lsnr":-10.5,"gweui":"0000024B080E0C5E"},{"tmst":4147169268,"time":"2016-09-06T11:50:30.259561Z","rssi":-120,"rcv_time":-576198901881706,"lsnr":-16.0,"gweui":"0000024B080600F0"}],"freq":868.5,"fopts":"","fcnt":5,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:45:05","port":2,"payload_encrypted":false,"payload":"0000FA0CCE56181A80","parsed":{"col_R":86,"col_G":24,"col_C":128,"col_B":26,"VBat1000tel":3278,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.278},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":3821966076,"time":"2016-09-06T11:45:05.058959Z","rssi":-115,"rcv_time":-576199227081709,"lsnr":-11.5,"gweui":"0000024B080600F0"}],"freq":868.3,"fopts":"","fcnt":4,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:39:41","port":2,"payload_encrypted":false,"payload":"0000FA0CCE55181A7F","parsed":{"col_R":85,"col_G":24,"col_C":127,"col_B":26,"VBat1000tel":3278,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.278},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":3615111284,"time":"2016-09-06T11:39:40.838837Z","rssi":-115,"rcv_time":-576199551165127,"lsnr":-1.0,"gweui":"0000024B0806019A"},{"tmst":3497738804,"time":"2016-09-06T11:39:40.844011Z","rssi":-120,"rcv_time":-576199551301787,"lsnr":-3.5,"gweui":"0000024B080600F0"},{"tmst":915557716,"time":"2016-09-06T11:39:40.389872Z","rssi":-124,"rcv_time":-576199551005481,"lsnr":-10.5,"gweui":"0000024B080E040C"}],"freq":868.1,"fopts":"","fcnt":3,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:34:20","port":2,"payload_encrypted":false,"payload":"0000FA0CCC55181A7F","parsed":{"col_R":85,"col_G":24,"col_C":127,"col_B":26,"VBat1000tel":3276,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.276},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":3291861292,"time":"2016-09-06T11:34:17.581406Z","rssi":-97,"rcv_time":-576199872557737,"lsnr":-4.2,"gweui":"0000024B0806019A"}],"freq":868.5,"fopts":"","fcnt":2,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:28:54","port":2,"payload_encrypted":false,"payload":"0000FA0CCC54181A7D","parsed":{"col_R":84,"col_G":24,"col_C":125,"col_B":26,"VBat1000tel":3276,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.276},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":2850261540,"time":"2016-09-06T11:28:53.366680Z","rssi":-111,"rcv_time":-576200198781797,"lsnr":-6.2,"gweui":"0000024B080600F0"},{"tmst":3076212844,"time":"2016-09-06T11:28:52.685636Z","rssi":-116,"rcv_time":-576200198754658,"lsnr":-13.8,"gweui":"0000024B080E0C5E"}],"freq":868.3,"fopts":"","fcnt":1,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:23:41","port":2,"payload_encrypted":false,"payload":"0300FA0CD250171978","parsed":{"col_R":80,"col_G":23,"col_C":120,"col_B":25,"VBat1000tel":3282,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":3,"Battery_Voltage":3.282},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":2654030196,"time":"2016-09-06T11:23:38.747008Z","rssi":-111,"rcv_time":-576200511743306,"lsnr":-10.8,"gweui":"0000024B0806019A"}],"freq":868.1,"fopts":"","fcnt":0,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:23:40","port":2,"payload_encrypted":false,"payload":"0300FA0CD250171978","parsed":{"col_R":80,"col_G":23,"col_C":120,"col_B":25,"VBat1000tel":3282,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":3,"Battery_Voltage":3.282},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":2536657492,"time":"2016-09-06T11:23:39.767416Z","rssi":-117,"rcv_time":-576200512381872,"lsnr":-9.5,"gweui":"0000024B080600F0"},{"tmst":280604100,"time":"2016-09-06T11:23:38.846172Z","rssi":-124,"rcv_time":-576200512393396,"lsnr":-10.8,"gweui":"0000024B080606AA"}],"freq":868.1,"fopts":"","fcnt":0,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:09:17","port":2,"payload_encrypted":false,"payload":"0000FA0CCC0B08071A","parsed":{"col_R":11,"col_G":8,"col_C":26,"col_B":7,"VBat1000tel":3276,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.276},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":1790425556,"time":"2016-09-06T11:09:15.155492Z","rssi":-114,"rcv_time":-576201375562765,"lsnr":-2.5,"gweui":"0000024B0806019A"}],"freq":868.1,"fopts":"","fcnt":15,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:09:16","port":2,"payload_encrypted":false,"payload":"0000FA0CCC0B08071A","parsed":{"col_R":11,"col_G":8,"col_C":26,"col_B":7,"VBat1000tel":3276,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":0,"Battery_Voltage":3.276},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":1673052644,"time":"2016-09-06T11:09:16.164557Z","rssi":-120,"rcv_time":-576201376001827,"lsnr":-6.2,"gweui":"0000024B080600F0"},{"tmst":3385838892,"time":"2016-09-06T11:09:15.707189Z","rssi":-122,"rcv_time":-576201375965596,"lsnr":-15.8,"gweui":"0000024B080E040C"}],"freq":868.1,"fopts":"","fcnt":15,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null},{"spreading_factor":11,"size":22,"received_at":"2016-09-06T11:51:57","port":2,"payload_encrypted":false,"payload":"0300FA0CCE56181A80","parsed":{"col_R":86,"col_G":24,"col_C":128,"col_B":26,"VBat1000tel":3278,"TempDegree":25.0,"Temp10tel":250,"ButtonsPressedBitmap":3,"Battery_Voltage":3.278},"mtype":"unconfirmed_data_up","modu":"LORA","gwrx":[{"tmst":55962892,"time":"2016-09-06T11:51:56.644556Z","rssi":-115,"rcv_time":-576198815405659,"lsnr":-4.2,"gweui":"0000024B0806019A"},{"tmst":4233557884,"time":"2016-09-06T11:51:56.652924Z","rssi":-119,"rcv_time":-576198815481653,"lsnr":-9.0,"gweui":"0000024B080600F0"},{"tmst":1651376772,"time":"2016-09-06T11:51:56.207089Z","rssi":-118,"rcv_time":-576198815482198,"lsnr":-13.5,"gweui":"0000024B080E040C"}],"freq":868.1,"fopts":"","fcnt":6,"device_eui":"00000000FCFCA4AA","datr":null,"codr":"4/5","bandwidth":125,"ack":null}]}`

func TestClient_ListPackets(t *testing.T) {
	client := setupTestClient(t)
	httpmock.Reset()
	httpmock.RegisterResponder("GET",
		"https://api.fireflyiot.com/api/v1/devices/eui/00000000FCFCA4AA/packets?auth=key",
		httpmock.NewStringResponder(200, allPacketsResponse),
	)
	
	r, err := client.ListDevicePackets("00000000FCFCA4AA", ListPacketsParams{})

	if err != nil {
		t.Error(err)
	}
	
	if len(r.Packets) != 10 {
		t.Error("Expected 10 packets but was", len(r.Packets))
	}
}
